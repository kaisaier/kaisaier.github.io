<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">

<script>
    (function(){
        if(''){
          alert('此文章并不公开, 输入文章密码方可阅读');
          var password = prompt();
          if (password !== ''){
            if (password != null) // 如果用户点击了确认而且密码错误的时候, 因为当password == null的时候说明用户点了取消
            {
              alert('Error!');
            }
            if (history.length > 1)
            {
              history.back();
            }
            else
            {
              window.location.href = "about:blank";
            }
          }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/dist/jquery.fancybox.css?v=3.2.10" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="UNP,TLPI,APUE,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="因为UNP第三部分（第三版13-31章）的内容结合APUE（UNIX环境高级编程）和TLPI（The Linux Programming Interface）来看才能比较清晰，所以笔记整理会穿插很多这两本书的内容 引申知识，作业控制以及相关命令  . . .">
<meta name="keywords" content="UNP,TLPI,APUE">
<meta property="og:type" content="article">
<meta property="og:title" content="重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(一)">
<meta property="og:url" content="https://kaisaier.github.io/2017/07/28/unp_chapter_thirdteen_to_thirty_one_note_first_part/index.html">
<meta property="og:site_name" content="凯">
<meta property="og:description" content="因为UNP第三部分（第三版13-31章）的内容结合APUE（UNIX环境高级编程）和TLPI（The Linux Programming Interface）来看才能比较清晰，所以笔记整理会穿插很多这两本书的内容 引申知识，作业控制以及相关命令  . . .">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://kaisaier.github.io/img/unp_chapter_thirdteen_to_thirty_one_note_first_part/daemon_command.jpg">
<meta property="og:image" content="https://kaisaier.github.io/img/unp_chapter_thirdteen_to_thirty_one_note_first_part/setid.jpg">
<meta property="og:updated_time" content="2019-08-24T07:33:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(一)">
<meta name="twitter:description" content="因为UNP第三部分（第三版13-31章）的内容结合APUE（UNIX环境高级编程）和TLPI（The Linux Programming Interface）来看才能比较清晰，所以笔记整理会穿插很多这两本书的内容 引申知识，作业控制以及相关命令  . . .">
<meta name="twitter:image" content="https://kaisaier.github.io/img/unp_chapter_thirdteen_to_thirty_one_note_first_part/daemon_command.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"scrollpercent":true,"onmobile":true,"dimmer":true},
    local_search: {"enable":true,"trigger":"auto","top_n_per_article":1},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"header":"slideUpBigIn","menu":"slideDownBigIn","logo":"bounceUpIn","post_block_else":"slideDownBigIn","post_header":"slideDownBigIn","post_body":"slideDownBigIn","coll_header":"slideDownBigIn","footer":"slideUpBigIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>








  <title>重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(一) | 凯</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">凯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ue4</p>
      
  </div>

  <div class="menu-item sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div class="menu-item site-search">
    
  
  <form class="site-search-form">
    <span class="search-icon fa fa-search"></span>
    <input type="text" id="local-search-input" class="st-search-input">
    <i id="local-search-close">×</i>
  </form>


<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>



  </div>
  <div id="local-search-result-pc" class="local-search-result-cls"></div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

       
    </ul>
  

  
    
  
</nav>



 </div>
    </header>

    <div id="local-search-result-mobile" class="local-search-result-cls"></div>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kaisaier.github.io/2017/07/28/unp_chapter_thirdteen_to_thirty_one_note_first_part/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kaisaier">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(一)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-28T19:01:21-07:00">
                2017-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NP/" itemprop="url" rel="index">
                    <span itemprop="name">NP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <div class="post-tags">
              
                <a href="/tags/UNP/" rel="tag"><i class="fa fa-tag"></i> UNP</a>
              
                <a href="/tags/TLPI/" rel="tag"><i class="fa fa-tag"></i> TLPI</a>
              
                <a href="/tags/APUE/" rel="tag"><i class="fa fa-tag"></i> APUE</a>
              
            </div>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/09/crontab笔记整理/" rel="next" title="crontab笔记整理">
                <i class="fa fa-chevron-left"></i> 
                <p class="post-nav-pre-next-title">
                  crontab笔记整理
                </p> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/29/unp_chapter_thirdteen_to_thirty_one_note_second_part/" rel="prev" title="重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(二)">
              <p class="post-nav-pre-next-title">
                  重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(二)
              </p> 
              <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      

      
      

      
        <p>因为UNP第三部分（第三版13-31章）的内容结合APUE（UNIX环境高级编程）和TLPI（The Linux Programming Interface）来看才能比较清晰，所以笔记整理会穿插很多这两本书的内容</p>
<h1 id="引申知识，作业控制以及相关命令"><a href="#引申知识，作业控制以及相关命令" class="headerlink" title="引申知识，作业控制以及相关命令"></a>引申知识，作业控制以及相关命令</h1><p> <img src="/img/unp_chapter_thirdteen_to_thirty_one_note_first_part/daemon_command.jpg" alt="daemon_command"></p>
<p><strong>. . .</strong><a id="more"></a></p>
<p><strong>注:</strong> 但是如上方到后台执行的进程，其父进程还是当前终端shell的进程，而一旦父进程退出，则会发送hangup信号给所有子进程，子进程收到hangup以后也会退出。</p>
<h1 id="13-4节"><a href="#13-4节" class="headerlink" title="13.4节"></a>13.4节</h1><p>本节主要讲守护进程的相关知识</p>
<h2 id="创建守护进程的步骤"><a href="#创建守护进程的步骤" class="headerlink" title="创建守护进程的步骤"></a>创建守护进程的步骤</h2><p>自定义一个daemon_init函数，涉及到知识点为“如何创建一个daemon（守护进程）”，实现步骤如下(两fork一set, u工文dev)：</p>
<!--
1．执行‘个fork()，之后父进程退出，子进程继续执行。（结果是daemon成为了init进程的
  子进程。）之所以要做这步是因为下面两个原因。
    假设daemon是从命令行启动的，父进程的终止会被shell发现，shell在发现之后会显
    示m另’个she[l提示符并让子进程继续在后台运行。
    子进程被确保不会成为+个进程组首进程，因为它从其父进程那里继承了进程组ID
    并且拥有了白己的唯的进程ID，而这个进程LD与继承而来的进程组ID是不同的，
    这样才能够成功地执行下面。个步骤。
2．子进程调用setsid()（参见34.3节）开启‘个新会话并释放它与控制终端之间的所有关联
  关系。
3．如果daemon从来没有打开过终端设备，那么就无需担心daemon会重新请求一个控制终
  端了。如果daemon后面可能会打开个终端设备，那么必须要采取措施来确保这个设备
  不会成为控制终端。这可以通过下面两种方式实现。
  一在所有可能应用到一个终端设备L的open()调用中指定O NOCTTY标记。
    或者更简单地说，在setsid()调用之后执行第：个fork0，然后再次让父进程退m并让
    孙子进程继续执行。这样就确保了子进程不会成为会话组饫，因此根据SystemV中获
    取终端的规则（Linux也遵循了这个规则），进程永远不会重新请求一个控制终端（参
    见34.4仃）。

    4．清除进程的umask（参见15.4.6节）以确保当daemon创建文件和目录时拥有所需的权限。
S．修改进程的当前工作目录，通常会改为根日录(／)。这样做是有必耍的，因为daemon通
  常会一直运行商垒系统关闭为止。如果daemon的当前】．作目录为可i包含／的文件系统，那
  么就无法卸载该文件系统（参见14.8.2节）。或者daemon可以将工作目录改为完成任务
  时所在的目录或在配置文件中定义的一个目录，只要包含这个口录的文件系统永远小会被
  卸载即可。如cron会将自身放在/var/spool/cron日录下。
6．关闭daemon从其父进程继承而来的所有打开着的文件描述符。（daemon可能需要保
  持继承而柬的文件描述的打开状态，因此这步是町选的或者是可变更的。）之所以
  需要这样做的原因有很多。由J。daemon失去了控制终端并且是在后台运行的，因此
  让daemon保持文件描述符0、1和2的打开状态毫无意义，因为它们指向的就是控
  制终端。此外，无法卸载长时间运行的daemon打开的文件所在的文件系统。因此，
  通常的做法是关闭所有无用的打开着的文件描述符，因为文件描述符是一种有限的
  资源。

  7．在关闭了文件描述符0、1和2之后，daemon通常会打开/dev/null并使用dup2()（或类似
  的函数）使所有这些描述符指向这个设备。之所以要这样做是因为下面两个原因。
    它确保了当daemon调用了在这些描述符上执行I/O的库函数时不会出乎意料地
    失败。
    一它防止了daemon后面使用描述符1或2打开…个文件的情况，因为库函数会将这些
    描述符当做标准输出和标准错误来写入数据（进而破坏了原有的数据）。
-->

<p><strong>(1)首先要做的是调用<a href="#umask介绍">umask</a>将文件模式创建屏蔽字设置为一个已知值(通常是0)。</strong><br>由继承得来的文件模式创建屏蔽字可能会被设置为拒绝某些权限。如果守护进程要创建文件，那么它可能要设置特定的权限。例如，若守护进程要创建组可读、组可写的文件，继承的文件模式创建屏蔽字可能会屏蔽上述两种权限中的一种，而使其无法发挥作用。另一方面，如果守护进程调用的库函数创建了文件，那么将文件模式创建屏蔽字设置为一个限制性更强的值（如007）可能会更明智，因为库函数可能不允许调用者通过一个显式的函数参数来设置权限。</p>
<p><strong>(2)调用fork，然后使父进程exit。</strong><br>这样做实现了下面几点。第一，如果该守护进程是作为一条简单的shell命令启动的，那么父进程终止会让shell认为这条命令已经执行完毕。<br>第二，虽然子进程继承了父进程的进程组ID，但获得了一个新的进程ID，这就保证了子进程不是一个进程组的组长进程。这是下面将要进行的setsid调用的先决条件。</p>
<p><strong>(3)调用setsid创建一个新会话。</strong><br>使调用进程：(a)成为新会话的首进程，(b)成为一个新进程组的组长进程．(c)没有控制终端。也可概括为 : 开启一个新会话并释放它与控制终端之间的所有关联关系</p>
<p><strong>(4)再次fork并杀掉首进程.</strong><br>这样就确保了子进程不是一个会话首进程， 根据linux中获取终端的规则（只有会话首进程才能请求一个控制终端）， 这样进程永远不会重新请求一个控制终端</p>
<p><strong>(5)将当前工作目录更改为根目录。</strong><br>从父进程处继承过来的当前工作目录可能在一个挂载的文件系统中。因为守护进程通常在系统再引导之前是一直存在的，所以如果守护进程的当前工作目录在一个挂载文件系统中，那么该文件系统就不能被卸载。<br>或者，某些守护进程还可能会把、与前工作目录更改到某个指定位置，并在此位置进行它们的<br>全部工作。例如，行式打印机假脱机守护进程就可能将其工作目录更改到它们的spool目录上。</p>
<p><strong>(6)关闭不再需要的文件描述符。</strong><br>这使守护进程不再持有从其父进程继承来的任何文件描述符（父进程可能是shell进程，或某个其他进程）。<br>可以使用open_max函数（见2.17节）或<br>getrlimit函数（见7.11节）来判定最高文件描述符值，并关闭直到该值的所有描述符。</p>
<p><strong>(7)某些守护进程打开/dev/null使其具有文件描述符0、l和2．这样，任何一个试图读标准输入、写标准输出或标准错误的库例程都不会产生任何效果。</strong><br>因为守护进程并不与终端设备相关联，所以其输出无处显示，也无处从交互式用户那里接收输入。<br>即使守护进程是从交互式会话启动的，但是守护进程是在后台运行的，所以登录会话的终止并不影响守护进程。如果其他用户在同一终端设备上登录，我们不希望在该终端上见到守护进程的输出，用户也不期望他们在终端上的输入被守护进程读取。<br>(</p>
<p>在关闭了文件描述符0、1和2之后，daemon通常会打开/dev/null并使用dup2()（或类似<br>的函数）使所有这些描述符指向这个设备。之所以要这样做是因为下面两个原因 :</p>
<ul>
<li>它确保了当daemon调用了在这些描述符上执行I/O的库函数时不会出乎意料地<br>  失败。</li>
<li>它防止了daemon后面使用描述符1或2打开…个文件的情况，因为库函数会将这些<br>  描述符当做标准输出和标准错误来写入数据（进而破坏了原有的数据）。</li>
</ul>
<p>)</p>
<h2 id="dup介绍"><a href="#dup介绍" class="headerlink" title="dup介绍"></a>dup介绍</h2><p>函数原型 : <code>int dup( int oldfd )</code></p>
<p>dup() 调用复制一个打开的文件描述符 oldfd , 并返回一个新描述符, 二者都指向同一打开的文件句柄. 系统会保证新描述符一定是编号值最低的未用文件描述符.</p>
<p>假设发起如下调用 : </p>
<p><code>newfd = dup(1);</code></p>
<p>再假定在正常情况下, shell已经代表程序打开了文件描述符0, 1和2, 且没有其他描述符在用, dup()调用会创建文件描述符1的副本, 返回的文件描述符编号值为3.</p>
<p>如果希望返回的文件描述符为2, 可以使用如下技术 :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(<span class="number">2</span>);</span><br><span class="line">newfd = dup(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>只有当描述符 0 已经打开时, 这段代码方可工作. </p>
<h2 id="dup2介绍"><a href="#dup2介绍" class="headerlink" title="dup2介绍"></a>dup2介绍</h2><p>如果想进一步简化上述代码, 同时总是能获得所期望的文件描述符, 可以调用dup2().</p>
<p>函数原型 : <code>int dup2( int oldfd, int newfd )</code></p>
<p>dup2函数跟dup函数相似，但dup2函数允许调用者规定一个有效描述符和目标描述符的id</p>
<p>。dup2函数成功返回时，目标描述符（dup2函数的第二个参数）将变成源描述符（dup2函数的</p>
<p>第一个参数）的复制品，换句话说，两个文件描述符现在都指向同一个文件，并且是函数第一</p>
<p>个参数指向的文件。</p>
<p>下面我们用一段代码加以说明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> oldfd;   </span><br><span class="line">oldfd = open(<span class="string">"app_log"</span>, (O_RDWR | O_CREATE), <span class="number">0644</span> );    </span><br><span class="line">dup2( oldfd, <span class="number">1</span> );    </span><br><span class="line">close( oldfd );</span><br></pre></td></tr></table></figure>

<p>本例中，我们打开了一个新文件，称为“app_log”，并收到一个文件描述符，该描述符</p>
<p>叫做fd1。我们调用dup2函数，参数为oldfd和1，这会导致用我们新打开的文件描述符替换掉</p>
<p>由1代表的文件描述符（即stdout，因为标准输出文件的id为1）。任何写到stdout的东西，现</p>
<p>在都将改为写入名为“app_log”的文件中。</p>
<h2 id="umask介绍"><a href="#umask介绍" class="headerlink" title="umask介绍"></a>umask介绍</h2><p>当我们登录系统之后创建一个文件总是有一个默认权限的，那么这个权限是怎么来的呢？这就是umask干的事情。umask设置了用户创建文件的默认 权限，它与chmod的效果刚好相反，umask设置的是权限“补码”，而chmod设置的是文件权限码。</p>
<h3 id="如何计算umask"><a href="#如何计算umask" class="headerlink" title="如何计算umask"></a>如何计算umask</h3><p>umask 命令允许你设定文件创建时的缺省模式，对应每一类用户(文件属主、同组用户、其他用户)存在一个相应的umask值中的数字。对于文件来说，这一数字的最 大值分别是6。系统不允许你在创建一个文本文件时就赋予它执行权限，必须在创建后用chmod命令增加这一权限。目录则允许设置执行权限，这样针对目录来 说，umask中各个数字最大可以到7。</p>
<p>例如，对于umask值0 0 2，相应的文件和目录缺省创建权限是什么呢？</p>
<p>第一步，我们首先写下目录具有全部权限的模式，即777 (所有用户都具有读、写和执行权限)。<br>第二步，在下面一行按照umask值写下相应的位，在本例中是0 0 2。<br>第三步，在接下来的一行中记下上面两行中没有匹配的位。这就是目录的缺省创建权限。<br>稍加练习就能够记住这种方法。<br>第四步，对于文件来说，在创建时不能具有执行权限，只要拿掉相应的执行权限比特即可。<br>这就是上面的例子， 其中umask值为0 0 2：</p>
<p>1) 文件的最大权限 rwx rwx rwx (777)<br>2) umask值为0 0 2 — — -w-<br>3) 目录权限 rwx rwx r-x (775) 这就是目录创建缺省权限<br>4) 文件权限 rw- rw- r– (664) 这就是文件创建缺省权限</p>
<p>下面是另外一个例子，假设这次u m a s k值为0 2 2：</p>
<p>1) 文件的最大权限 rwx rwx rwx (777)<br>2 ) u m a s k值为0 2 2 — -w- -w-<br>3) 目录权限 rwx r-x r-x (755) 这就是目录创建缺省权限<br>4) 文件权限 rw- r– r– (644) 这就是文件创建缺省权限</p>
<h2 id="创建守护进程的例子程序"><a href="#创建守护进程的例子程序" class="headerlink" title="创建守护进程的例子程序"></a>创建守护进程的例子程序</h2><p>下面是becomeDaemon()函数的实现，becomeDaeomon()函数接收一个位掩码参数flags，它允许调用者有选择地执行其中的步<br>骤，具体可参考注释。</p>
<p>become_daemon.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BECOME_DAEMON_H             <span class="comment">/* Prevent double inclusion */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BECOME_DAEMON_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bit-mask values for 'flags' argument of becomeDaemon() */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BD_NO_CHDIR           01    <span class="comment">/* Don't chdir("/") */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BD_NO_CLOSE_FILES     02    <span class="comment">/* Don't close all open files */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BD_NO_REOPEN_STD_FDS  04    <span class="comment">/* Don't reopen stdin, stdout, and</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                       stderr to /dev/null */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BD_NO_UMASK0         010    <span class="comment">/* Don't do a umask(0) */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BD_MAX_CLOSE  8192          <span class="comment">/* Maximum file descriptors to close if</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                       sysconf(_SC_OPEN_MAX) is indeterminate */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">becomeDaemon</span><span class="params">(<span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>become_daemon.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"become_daemon.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"tlpi_hdr.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>                                     <span class="comment">/* Returns 0 on success, -1 on error */</span></span><br><span class="line">becomeDaemon(<span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> maxfd, fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (fork()) &#123;                   <span class="comment">/* Become background process */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>: <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:  <span class="keyword">break</span>;                     <span class="comment">/* Child falls through... */</span></span><br><span class="line">    <span class="keyword">default</span>: _exit(EXIT_SUCCESS);       <span class="comment">/* while parent terminates */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setsid() == <span class="number">-1</span>)                 <span class="comment">/* Become leader of new session */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (fork()) &#123;                   <span class="comment">/* Ensure we are not session leader */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>: <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:  <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>: _exit(EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; BD_NO_UMASK0))</span><br><span class="line">        umask(<span class="number">0</span>);                       <span class="comment">/* Clear file mode creation mask */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; BD_NO_CHDIR))</span><br><span class="line">        chdir(<span class="string">"/"</span>);                     <span class="comment">/* Change to root directory */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; BD_NO_CLOSE_FILES)) &#123; <span class="comment">/* Close all open files */</span></span><br><span class="line">        maxfd = sysconf(_SC_OPEN_MAX);</span><br><span class="line">        <span class="keyword">if</span> (maxfd == <span class="number">-1</span>)                <span class="comment">/* Limit is indeterminate... */</span></span><br><span class="line">            maxfd = BD_MAX_CLOSE;       <span class="comment">/* so take a guess */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (fd = <span class="number">0</span>; fd &lt; maxfd; fd++)</span><br><span class="line">            close(fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; BD_NO_REOPEN_STD_FDS)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// /* Standard file descriptors. */</span></span><br><span class="line">        <span class="comment">// #define STDIN_FILENO 0 /* Standard input. */</span></span><br><span class="line">        <span class="comment">// #define STDOUT_FILENO 1 /* Standard output. */</span></span><br><span class="line">        <span class="comment">// #define STDERR_FILENO 2 /* Standard error output. */</span></span><br><span class="line"></span><br><span class="line">        close(STDIN_FILENO);            <span class="comment">/* Reopen standard fd's to /dev/null */</span></span><br><span class="line"></span><br><span class="line">        fd = open(<span class="string">"/dev/null"</span>, O_RDWR); <span class="comment">// open 返回的文件描述符一定是最小的未被使用的描述符。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd != STDIN_FILENO)         <span class="comment">/* 'fd' should be 0 */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (dup2(STDIN_FILENO, STDOUT_FILENO) != STDOUT_FILENO)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (dup2(STDIN_FILENO, STDERR_FILENO) != STDERR_FILENO)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="nohup和setsid用法"><a href="#nohup和setsid用法" class="headerlink" title="nohup和setsid用法"></a>nohup和setsid用法</h1><p>如果我们要在退出shell的时候继续运行进程，则需要使用nohup忽略hangup信号，或者setsid将父进程设为init进程；</p>
<p> <img src="/img/unp_chapter_thirdteen_to_thirty_one_note_first_part/setid.jpg" alt="setid"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">b@b-VirtualBox:~/my_temp_test$ nohup ./o_multi_thread_process &amp;</span><br><span class="line">[1] 3487</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class="line">^C</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">jobs</span></span><br><span class="line">[1]+  Running                 nohup ./o_multi_thread_process &amp;</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ ps -ef | grep multi</span><br><span class="line">b         3487  3004  0 20:05 pts/3    00:00:00 ./o_multi_thread_process</span><br><span class="line">b         3488  3487  0 20:05 pts/3    00:00:00 ./o_multi_thread_process</span><br><span class="line">b         3491  3004  0 20:05 pts/3    00:00:00 grep --color=auto multi</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">bg</span> %1</span><br><span class="line">bash: <span class="built_in">bg</span>: job 1 already <span class="keyword">in</span> background</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">fg</span> %1</span><br><span class="line">nohup ./o_multi_thread_process</span><br><span class="line">^Z</span><br><span class="line">[1]+  Stopped                 nohup ./o_multi_thread_process</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">bg</span> %1</span><br><span class="line">[1]+ nohup ./o_multi_thread_process &amp;</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">jobs</span> -l</span><br><span class="line">[1]+  3487 Running                 nohup ./o_multi_thread_process &amp;</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">fg</span> %1</span><br><span class="line">nohup ./o_multi_thread_process</span><br><span class="line">^C</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">jobs</span></span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ ps -ef | grep multi</span><br><span class="line">b         3499  3004  0 20:11 pts/3    00:00:00 grep --color=auto multi</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ setsid ./o_multi_thread_process &amp;</span><br><span class="line">[1] 3502</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ ProcessA: 3503 step1</span><br><span class="line">ProcessA: 3503 thread 139947724490496 step2</span><br><span class="line">ProcessA: 3503 thread 139947724490496 step3</span><br><span class="line">ProcessB: 3504 step1</span><br><span class="line">ProcessB: 3504 step2</span><br><span class="line">ProcessB: 3504 step3</span><br><span class="line">^C</span><br><span class="line">[1]+  Done                    setsid ./o_multi_thread_process</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ ps -ef | grep multi</span><br><span class="line">b         3503  1256  0 20:12 ?        00:00:00 ./o_multi_thread_process</span><br><span class="line">b         3504  3503  0 20:12 ?        00:00:00 ./o_multi_thread_process</span><br><span class="line">b         3507  3004  0 20:12 pts/3    00:00:00 grep --color=auto multi</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">jobs</span></span><br></pre></td></tr></table></figure>

<h1 id="disown用法"><a href="#disown用法" class="headerlink" title="disown用法"></a>disown用法</h1><p>那么对于已经在后台运行的进程，如果我们要在退出shell的时候继续运行进程, 该怎么办呢？可以使用disown命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">b@b-VirtualBox:~/my_temp_test$ ./o_multi_thread_process &amp;</span><br><span class="line">[1] 3523</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ ProcessA: 3523 step1</span><br><span class="line">ProcessA: 3523 thread 140501901821696 step2</span><br><span class="line">ProcessA: 3523 thread 140501901821696 step3</span><br><span class="line">ProcessB: 3524 step1</span><br><span class="line">ProcessB: 3524 step2</span><br><span class="line">ProcessB: 3524 step3</span><br><span class="line">^C</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">jobs</span> -l</span><br><span class="line">[1]+  3523 Running                 ./o_multi_thread_process &amp;</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">disown</span> -h %1</span><br><span class="line">b@b-VirtualBox:~/my_temp_test$ <span class="built_in">jobs</span></span><br><span class="line">[1]+  Running                 ./o_multi_thread_process &amp;</span><br></pre></td></tr></table></figure>


      


      

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/UNP/" rel="tag"><i class="fa fa-tag"></i> UNP</a>
            
              <a href="/tags/TLPI/" rel="tag"><i class="fa fa-tag"></i> TLPI</a>
            
              <a href="/tags/APUE/" rel="tag"><i class="fa fa-tag"></i> APUE</a>
            
          </div>
        

        
        
        

        
          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2017/07/09/crontab笔记整理/" rel="next" title="crontab笔记整理">
                  <i class="fa fa-chevron-left"></i> 
                  <p class="post-nav-pre-next-title">
                    crontab笔记整理
                  </p> 
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2017/07/29/unp_chapter_thirdteen_to_thirty_one_note_second_part/" rel="prev" title="重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(二)">
                <p class="post-nav-pre-next-title">
                    重读UNP（UNIX网络编程）13章到31章笔记整理（结合TLPI和APUE两书的笔记整理）(二)
                </p> 
                <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        

        
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  

  <aside id="sidebar" class="sidebar">

    
      
        <div id="sidebar-dimmer"></div>
      
    

    <div class="sidebar-inner">
    
      <div class="sidebar-toggle-inside motion-element">
        <div class="sidebar-toggle-line-wrap">
          <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
        </div>
      </div>

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/" class="site-author-image" rel="start" style="border:none">
            <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="kaisaier">
          </a>
          <p class="site-author-name" itemprop="name">kaisaier</p>
           
              <p class="site-description motion-element" itemprop="description">欢迎订阅交流</p>
          
        </div>

        <nav class="site-state motion-element">

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">183</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">69</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

          <div class="site-state-item site-state-about">
            <a href="/about/">
              <span class="site-state-item-about fa fa-fw fa-user"></span>
              <span class="site-state-item-name">关于</span>
            </a>
          </div>
          
        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kaisaier" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="1285310959@qq.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
          
          <!-- 网易云音乐 -->
            <!-- <div class="netease-cloud-music"> -->
              <!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=110 src="//music.163.com/outchain/player?type=0&id=992743594&auto=0&height=90"></iframe> -->
            <!-- </div> -->
          <!-- 网易云音乐 -->

        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://laod.cn/" title="老爹助你一臂之力" target="_blank">老爹助你一臂之力</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.dayanzai.me/" title="大眼仔眼睛大" target="_blank">大眼仔眼睛大</a>
                </li>
              
            </ul>
          </div>
        

        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#引申知识，作业控制以及相关命令"><span class="nav-number">1.</span> <span class="nav-text">引申知识，作业控制以及相关命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13-4节"><span class="nav-number">2.</span> <span class="nav-text">13.4节</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建守护进程的步骤"><span class="nav-number">2.1.</span> <span class="nav-text">创建守护进程的步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dup介绍"><span class="nav-number">2.2.</span> <span class="nav-text">dup介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dup2介绍"><span class="nav-number">2.3.</span> <span class="nav-text">dup2介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#umask介绍"><span class="nav-number">2.4.</span> <span class="nav-text">umask介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何计算umask"><span class="nav-number">2.4.1.</span> <span class="nav-text">如何计算umask</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建守护进程的例子程序"><span class="nav-number">2.5.</span> <span class="nav-text">创建守护进程的例子程序</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nohup和setsid用法"><span class="nav-number">3.</span> <span class="nav-text">nohup和setsid用法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#disown用法"><span class="nav-number">4.</span> <span class="nav-text">disown用法</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kaisaier</span>
</div>



        

        
      </div>
    </footer>

    <!--
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      
        <span id="scrollpercent"><span>0</span>%</span>
      
    </div>
    -->

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/dist/jquery.fancybox.js?v=3.2.10"></script>


  




  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






    <link rel="stylesheet" href="/css/gitalk.css">
    <script src="/js/src/gitalk.min.js"></script>
    <script type="text/javascript">
		var gitalk = new Gitalk({
            clientID: '7b952c6a994fea0a45a9',
            clientSecret: '662cf6468b397efa59bf95746b679c07399e7eed',
            repo: 'kaisaier.github.io',
            owner: 'kaisaier',
            admin: ['kaisaier'], 
            id: location.pathname,
            distractionFreeMode: 'true'
		})
		gitalk.render('gitalk-container')           
    </script>

  

  <script type="text/javascript">

    var searchFunc = function (path, search_id, content_id) {
      // 0x00. environment initialization
      'use strict';

      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      var datas = [];
      var is_load_xml_finished = 0;

      /* loading css1 : Dot Css Loader*/
      var DotLoader = "<div class='loader'>Loading...</div>";

      /* loading css2 : Pure Css Loader - Square */
      var SquareLoader = 
        "<div class='loader'>" +
          "<div class='square' ></div>" +
          "<div class='square'></div>" +
          "<div class='square last'></div>" +
          "<div class='square clear'></div>" +
          "<div class='square'></div>" +
          "<div class='square last'></div>" +
          "<div class='square clear'></div>" +
          "<div class='square '></div>" +
          "<div class='square last'></div>" +
        "</div>";

      var ProgressBar = 
          "<div class='progress-bar'>" +
            "<div class='progress-bar-charge'></div>" +
          "</div>";

      var str = "";
      var keywords = [];
      var temp_keyword = "";

      // 是否为第一个字母被键入的标志位
      var first_char_flag = 0;

      // 因为在移动设备上, 点击搜索之后会 scroll 到页面顶部, 所以需要记录之前的页面y坐标值, 以便于搜索完点击 close 按钮之后 scroll 回原来的页面坐标值.
      var last_page_y = 0;

      var local_search_tips = 
            "<span class='local-search-empty'>" + "玩命搜索中!! 研究表明, 人类能够忍受的最长等待时间为8秒..." + "</span>" +
            "<span class='local-search-empty'>" + "但请相信我, 我绝对不可能那么旷日持久的..." + "</span>";

      function CloseLocalSearch()
      {
        first_char_flag = 0;

        $('#local-search-input').val('');
        $('#local-search-close').hide();

        // $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownOut', 200);

        $('#' + content_id).attr("headroom_special_attr","true"); 
        
        if (isMobile())
        {
          $('body').scrollTop(last_page_y);
          $('#' + content_id).hide();
        }
        else
        {
          $('#' + content_id).velocity('stop').velocity( 'transition.bounceUpOut', 200 );
        }

        // $('#' + content_id).velocity('stop').velocity( isMobile() ? 'transition.fadeOut' : 'transition.bounceUpOut', {
        //   // delay: isMobile() ? 50 : 0,
        //   duration: isMobile() ? 500 : 200,
        //   // begin: function() { 
        //   //   if (isMobile())
        //   //   {
        //   //     $('body').scrollTop(last_page_y);
        //   //   } 
        //   // }
        //   complete: function () {
        //     if (isMobile())
        //     {
        //       if (last_page_y < 20000)
        //       {
        //         $('body').velocity('scroll', { offset: last_page_y+"px", duration: last_page_y < 10000 ? 1000 : 2000 });
        //       }
        //       else
        //       {
        //         $('body').scrollTop(last_page_y);
        //       }
        //       // $('body').velocity('scroll');

        //       // $('html,body').animate({
        //       //   scrollTop: last_page_y
        //       // },400);
        //       // $('body').velocity('transition.slideDownIn', 1000);
        //       // $('body').velocity('scroll', { offset: last_page_y+"px", duration: document.body.scrollHeight < 20000 ? 1500 : 3000 });
        //     }
        //   }
        // });
      }

      function handleSearch()
      {
        if (keywords.length <= 0) {
          return;
        }
        $resultContent.innerHTML = "";

        // 0x04. perform local searching
        if (is_load_xml_finished == 0)
        {
          $resultContent.innerHTML = 
            "<ul class='local-search-empty-ul'>" + 
            local_search_tips +
            ProgressBar;
        }
        else
        {
          datas.forEach(function (data) {
            var isMatch = true;
            var content_index = [];
            if (!data.title || data.title.trim() === '') {
              data.title = "Untitled";
            }
            var is_encrypted = data.encrypted.trim() == '1'
            var is_sensitive = CONFIG.local_search.sensitive_word && data_content.indexOf(CONFIG.local_search.sensitive_word) >= 0
            var orig_data_title = data.title.trim();
            var data_title = orig_data_title.toLowerCase();
            var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
            var data_content = orig_data_content.toLowerCase();
            var data_url = decodeURIComponent(data.url);
            var index_title = -1;
            var index_content = -1;
            var first_occur = -1;
            // only match artiles with not empty contents
            if (data_content !== '') {
              keywords.forEach(function (keyword, i) {
                index_title = data_title.indexOf(keyword);
                index_content = (is_sensitive || is_encrypted) ? -1 : data_content.indexOf(keyword);

                if (index_title < 0 && index_content < 0) {
                  isMatch = false;
                } else {
                  if (index_content < 0) {
                    index_content = 0;
                  }
                  if (i == 0) {
                    first_occur = index_content;
                  }
                  // content_index.push({index_content:index_content, keyword_len:keyword_len});
                }
              });
            } else {
              isMatch = false;
            }
            // 0x05. show search results
            if (isMatch) {
              var content = orig_data_content;
              if (first_occur >= 0) {
                var match_content = "";
                if (!is_sensitive && !is_encrypted)
                {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  match_content = content.substr(start, end);
                }

                // highlight all keywords
                var regS = "";
                if (match_content != "")
                {
                  keywords.forEach(function (keyword) {
                    regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<b class=\"search-keyword\">" + keyword + "</b>");
                    orig_data_title = orig_data_title.replace(regS, "<b class=\"search-keyword\">" + keyword + "</b>");
                  });
                }
                else
                {
                  keywords.forEach(function (keyword) {
                    regS = new RegExp(keyword, "gi");
                    orig_data_title = orig_data_title.replace(regS, "<b class=\"search-keyword\">" + keyword + "</b>");
                  });
                }

                
                
                str += "<li><a href='" + data_url + "' class='search-result-title' target='_blank'>" + orig_data_title + "</a>";

                str += "<p class=\"search-result\">" + match_content + "...</p>"
              }
              str += "</li>";
            }
          });

          str += "</ul>";
          $('#local-search-close').show();
          if (str.indexOf('<li>') === -1) {
            return $resultContent.innerHTML = 
              "<ul class='local-search-empty-ul'><span class='local-search-empty'>找不到, 换个搜索关键字试一哈.<span></ul>";
          }
          $resultContent.innerHTML = str;
        }
      }

      $input.addEventListener('input', function () {
        

        // 0x03. parse query to keywords list
        str = '<ul class=\"search-result-list\">';
        temp_keyword = this.value.trim();
        if (temp_keyword.length <= 0) {
          CloseLocalSearch();
          return;
        }

        keywords = temp_keyword.toLowerCase().split(/[\s\-]+/);
        handleSearch();

        // 当用户键入第一个字母的时候的动画处理逻辑 : 
        // 当 first_char_flag 为 0 的时候, 
        // 要播放一个动画
        if (first_char_flag == 0)
        {
        
          if (isMobile())
          {
            last_page_y = window.pageYOffset;
            $('body').scrollTop(0);
          }
          first_char_flag = 1;
          $('#' + content_id).removeAttr("headroom_special_attr");
          
          $('#' + content_id).velocity('stop').velocity('transition.slideDownIn', 300);

          $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownIn', 1000);
        }

      });


      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text(),
              encrypted: $("encrypted", this).text(),
            };
          }).get();

          // setTimeout(function(){
          //   is_load_xml_finished = 1;

          //   handleSearch();
          //   $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownIn', 800);
          // }, 2000);
          
          is_load_xml_finished = 1;

          handleSearch();
          $('.local-search-result-cls ul li').velocity('stop').velocity('transition.slideDownIn', 800);
        }
      });

      $(document).on('click', '#local-search-close', function() {
        CloseLocalSearch();
      });

      // $(document).on('blur', '#local-search-input', function(e) {
      //   // console.log(document.activeElement.getAttribute('class'));
        
      //   if (isMobile() == false)
      //   {
      //     CloseLocalSearch();
      //   }
      // });
      
      
    }

    function isMobile() {
      var userAgent = window.navigator.userAgent;

      var isiPad = userAgent.match(/iPad/i) !== null;
      var mobileUA = [
        'iphone', 'android', 'phone', 'mobile',
        'wap', 'netfront', 'x11', 'java', 'opera mobi',
        'opera mini', 'ucweb', 'windows ce', 'symbian',
        'symbianos', 'series', 'webos', 'sony',
        'blackberry', 'dopod', 'nokia', 'samsung',
        'palmsource', 'xda', 'pieplus', 'meizu',
        'midp' ,'cldc' , 'motorola', 'foma',
        'docomo', 'up.browser', 'up.link', 'blazer',
        'helio', 'hosin', 'huawei', 'novarra',
        'coolpad', 'webos', 'techfaith', 'palmsource',
        'alcatel', 'amoi', 'ktouch', 'nexian',
        'ericsson', 'philips', 'sagem', 'wellcom',
        'bunjalloo', 'maui', 'smartphone', 'iemobile',
        'spice', 'bird', 'zte-', 'longcos',
        'pantech', 'gionee', 'portalmmm', 'jig browser',
        'hiptop', 'benq', 'haier', '^lct',
        '320x320', '240x320', '176x220'
      ];
      var pattern = new RegExp(mobileUA.join('|'), 'i');

      return !isiPad && userAgent.match(pattern);
    }

    var getSearchFile = function(){
      var path = "/search.xml";
      var local_search_result_name = isMobile() ? "local-search-result-mobile" : "local-search-result-pc";
      searchFunc(path, 'local-search-input', local_search_result_name);
    }

  </script>





  

  

  

  

  

  


  <!-- <script type="text/javascript" src="/lib/wobble_window/wobblewindow.js"> </script>
<script type="text/javascript" src="/js/src/custom.js"></script>-->
</body>
</html>


<!-- 页面点击小红心 -->

  <script type="text/javascript" src="/js/src/love.js"></script>





<script type="text/javascript" src="/js/src/headroom.js"></script> 
